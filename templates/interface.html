<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BedsideBot - Patient Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
            height: 100vh;
            color: white;
        }

        .fullscreen-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .top-bar-controls {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }

        .patient-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .patient-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .patient-details h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .patient-details p {
            color: #b0b0b0;
            font-size: 14px;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-active { background: #4CAF50; }
        .status-listening { background: #2196F3; }
        .status-tracking { background: #FF9800; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-content {
            flex: 1;
            display: flex;
            position: relative;
        }

        .video-section {
            flex: 1;
            position: relative;
            background: #000;
        }

        .video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .detection-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .detection-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detection-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .control-panel {
            width: 400px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-left: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .panel-header h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .panel-header p {
            color: #b0b0b0;
            font-size: 12px;
        }

        .action-grid {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .action-button {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .action-button.active {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-color: #4CAF50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
            animation: activeGlow 2s infinite;
        }

        @keyframes activeGlow {
            0%, 100% { box-shadow: 0 0 30px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 40px rgba(76, 175, 80, 0.8); }
        }

        .action-icon {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        .action-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .action-subtitle {
            font-size: 12px;
            color: #b0b0b0;
        }

        .exit-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(244, 67, 54, 0.9);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1001;
        }

        .exit-button:hover {
            background: rgba(244, 67, 54, 1);
        }

        .notification-toast {
            position: fixed;
            top: 100px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification-toast.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="fullscreen-container">
        <div class="top-bar">
            <div class="patient-info">
                <div class="patient-avatar">üë§</div>
                <div class="patient-details">
                    <h2 id="patientName">Loading...</h2>
                    <p id="patientDetails">ID: -- | Bed: -- | Room: --</p>
                    <p id="patientCondition">Condition: --</p>
                </div>
            </div>
            
            <div class="top-bar-controls">
                <button class="exit-button" onclick="toggleFullscreen()" style="position: static; background: rgba(52, 152, 219, 0.9);">Toggle Fullscreen</button>
                <button class="exit-button" onclick="leavePatientMonitoring()" style="position: static;">Leave Patient Monitoring</button>
            </div>
            
            <div class="system-status">
                <div class="status-indicator">
                    <div class="status-dot status-active"></div>
                    <span>System Active</span>
                </div>
                <div class="status-indicator" id="voiceStatus">
                    <div class="status-dot status-listening"></div>
                    <span>Voice Listening</span>
                </div>
                <div class="status-indicator" id="handStatus">
                    <div class="status-dot status-tracking"></div>
                    <span>Hand Tracking</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="video-section">
                <video class="video-feed" id="videoFeed" autoplay playsinline muted style="background: #000; border-radius: 10px;"></video>
                
                <div class="video-overlay">
                    <div class="detection-info">
                        <div class="detection-item">
                            <div class="detection-icon" style="background: #4CAF50;"></div>
                            <span id="handGesture">Hand: None</span>
                        </div>
                        <div class="detection-item">
                            <div class="detection-icon" style="background: #2196F3;"></div>
                            <span id="voiceCommand">Voice: Listening...</span>
                        </div>
                        <div class="detection-item">
                            <div class="detection-icon" style="background: #FF9800;"></div>
                            <span id="eyeGaze">Gaze: Center</span>
                        </div>
                        <div class="detection-item">
                            <div class="detection-icon" style="background: #9C27B0;"></div>
                            <span id="systemFPS">FPS: --</span>
                        </div>
                        <div class="detection-item">
                            <div class="detection-icon" style="background: #FF5722;"></div>
                            <span id="lastAction">Last: None</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <div class="panel-header">
                    <h3>Patient Actions</h3>
                    <p>Detected requests will highlight automatically</p>
                </div>
                
                <div class="action-grid">
                    <div class="action-button" data-action="1">
                        <span class="action-icon">üë©‚öïÔ∏è</span>
                        <div class="action-title">Call Nurse</div>
                        <div class="action-subtitle">1 Finger</div>
                    </div>
                    
                    <div class="action-button" data-action="2">
                        <span class="action-icon">üíß</span>
                        <div class="action-title">Water</div>
                        <div class="action-subtitle">2 Fingers</div>
                    </div>
                    
                    <div class="action-button" data-action="3">
                        <span class="action-icon">üçΩÔ∏è</span>
                        <div class="action-title">Food</div>
                        <div class="action-subtitle">3 Fingers</div>
                    </div>
                    
                    <div class="action-button" data-action="4">
                        <span class="action-icon">üöø</span>
                        <div class="action-title">Bathroom</div>
                        <div class="action-subtitle">4 Fingers</div>
                    </div>
                    
                    <div class="action-button" data-action="5">
                        <span class="action-icon">üö®</span>
                        <div class="action-title">Emergency</div>
                        <div class="action-subtitle">5 Fingers</div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <h4 style="margin-bottom: 10px;">Test Gestures</h4>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="simulateGesture(1)" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">1</button>
                            <button onclick="simulateGesture(2)" style="padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">2</button>
                            <button onclick="simulateGesture(3)" style="padding: 5px 10px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer;">3</button>
                            <button onclick="simulateGesture(4)" style="padding: 5px 10px; background: #9C27B0; color: white; border: none; border-radius: 5px; cursor: pointer;">4</button>
                            <button onclick="simulateGesture(5)" style="padding: 5px 10px; background: #F44336; color: white; border: none; border-radius: 5px; cursor: pointer;">5</button>
                        </div>
                        <p style="font-size: 12px; margin-top: 5px; color: #ccc;">Click to test gesture detection</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification-toast" id="notificationToast">
        <div id="toastMessage">Action detected!</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script>
        let isFullscreen = false;
        let buttonCheckInterval;
        let currentAction = null;
        let recognition = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadPatientInfo();
            startMonitoring();
            initializeCamera();
            initializeVoiceRecognition();
            initializeHandGestureDetection();
        });

        async function initializeCamera() {
            const video = document.getElementById('videoFeed');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 }, 
                    audio: false 
                });
                video.srcObject = stream;
                showNotification('Camera initialized successfully');
            } catch (err) {
                console.error('Camera error:', err);
                video.style.background = '#333';
                video.innerHTML = '<div style="color: white; text-align: center; padding: 50px; font-size: 18px;">üìπ Camera access required<br><br>Please allow camera access and refresh the page</div>';
            }
        }
        
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const command = event.results[event.results.length - 1][0].transcript.toLowerCase();
                    document.getElementById('voiceCommand').textContent = `Voice: "${command}"`;
                    
                    // Send to backend
                    fetch('/voice_command', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command: command })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            handleActionDetected(data.button, data.message);
                        }
                    });
                };
                
                recognition.onerror = function(event) {
                    console.log('Speech recognition error:', event.error);
                };
                
                recognition.start();
                
                recognition.onend = function() {
                    setTimeout(() => recognition.start(), 1000);
                };
                
                showNotification('Voice recognition initialized');
            } else {
                document.getElementById('voiceCommand').textContent = 'Voice: Not supported in this browser';
            }
        }

        function loadPatientInfo() {
            fetch('/api/get_patients')
                .then(response => response.json())
                .then(data => {
                    if (data.patients && data.patients.length > 0) {
                        const patient = data.patients[0];
                        document.getElementById('patientName').textContent = patient.fullName || patient.name;
                        document.getElementById('patientDetails').textContent = `ID: ${patient.patientId || patient.id} | Bed: ${patient.bedNumber || patient.bed_number} | Room: ${patient.roomNumber || 'N/A'}`;
                        document.getElementById('patientCondition').textContent = `Condition: ${patient.primaryCondition || 'N/A'}`;
                        startPatientMonitoring(patient.name, patient.bed_number);
                    } else {
                        document.getElementById('patientName').textContent = 'No Patient Registered';
                        document.getElementById('bedNumber').textContent = 'Please register a patient first';
                    }
                })
                .catch(error => {
                    console.error('Error loading patient info:', error);
                    document.getElementById('patientName').textContent = 'Error Loading Patient';
                });
        }
        
        function startPatientMonitoring(patientName, bedNumber) {
            fetch('/start_monitoring', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    patientName: patientName,
                    bedNumber: bedNumber,
                    features: ['Hand Sign Detection', 'Voice Recognition', 'Face Detection']
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Monitoring started:', data);
            })
            .catch(error => {
                console.error('Error starting monitoring:', error);
            });
        }

        function startMonitoring() {
            startButtonPolling();
            showNotification('Monitoring started - System is now active');
        }

        function startButtonPolling() {
            if (buttonCheckInterval) {
                clearInterval(buttonCheckInterval);
            }

            buttonCheckInterval = setInterval(() => {
                fetch('/get_selected_button')
                    .then(response => response.json())
                    .then(data => {
                        updateActionButtons(data.button);
                        updateDetectionInfo(data);
                        
                        if (data.button) {
                            if (data.button !== currentAction || !currentAction) {
                                currentAction = data.button;
                                handleActionDetected(data.button, data.text);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error polling for button:', error);
                    });
            }, 100);
        }

        function updateActionButtons(activeButton) {
            if (activeButton) {
                const activeBtn = document.querySelector(`.action-button[data-action="${activeButton}"]`);
                if (activeBtn && !activeBtn.classList.contains('active')) {
                    activeBtn.classList.add('active');
                    setTimeout(() => {
                        activeBtn.classList.remove('active');
                    }, 3000);
                }
            }
        }

        function updateDetectionInfo(data) {
            if (data.button) {
                document.getElementById('handGesture').textContent = `Hand: ${data.button} finger(s)`;
                document.getElementById('lastAction').textContent = `Last: ${data.text}`;
            } else {
                document.getElementById('handGesture').textContent = 'Hand: None';
            }
        }

        function handleActionDetected(action, text) {
            showNotification(`Patient Request: ${text}`);
            
            if (action == 5) {
                showNotification('üö® EMERGENCY ALERT - Immediate assistance required!');
            }
            
            setTimeout(() => {
                currentAction = null;
            }, 3000);
        }

        function showNotification(message) {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        let hands, camera;
        let lastGestureTime = 0;
        let lastDetectedFingers = 0;
        
        function initializeHandGestureDetection() {
            const video = document.getElementById('videoFeed');
            
            // Initialize MediaPipe Hands
            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onHandResults);
            
            // Initialize camera
            camera = new Camera(video, {
                onFrame: async () => {
                    await hands.send({image: video});
                },
                width: 640,
                height: 480
            });
            
            camera.start();
        }
        
        function onHandResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const fingerCount = countFingers(landmarks);
                
                // Only process if different from last detection and enough time passed
                const now = Date.now();
                if (fingerCount !== lastDetectedFingers && (now - lastGestureTime) > 2000) {
                    lastDetectedFingers = fingerCount;
                    lastGestureTime = now;
                    
                    if (fingerCount >= 1 && fingerCount <= 5) {
                        document.getElementById('handGesture').textContent = `Hand: ${fingerCount} finger(s)`;
                        
                        // Send to backend
                        fetch('/set_button', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ button: fingerCount })
                        });
                        
                        handleActionDetected(fingerCount, getActionName(fingerCount));
                    }
                }
            }
        }
        
        function countFingers(landmarks) {
            const tipIds = [4, 8, 12, 16, 20]; // Thumb, Index, Middle, Ring, Pinky tips
            const pipIds = [3, 6, 10, 14, 18]; // PIP joints for comparison
            
            let fingers = 0;
            
            // Thumb (different logic - compare x coordinates)
            if (landmarks[tipIds[0]].x > landmarks[pipIds[0]].x) {
                fingers++;
            }
            
            // Other fingers (compare y coordinates - tip should be above PIP)
            for (let i = 1; i < 5; i++) {
                if (landmarks[tipIds[i]].y < landmarks[pipIds[i]].y) {
                    fingers++;
                }
            }
            
            return fingers;
        }
        
        function getActionName(fingerCount) {
            const actions = {
                1: "Call Nurse",
                2: "Water", 
                3: "Food",
                4: "Bathroom",
                5: "Emergency"
            };
            return actions[fingerCount] || "Unknown";
        }
        
        // Add manual gesture buttons for testing
        function simulateGesture(fingers) {
            fetch('/set_button', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ button: fingers })
            });
            handleActionDetected(fingers, `Manual: ${fingers} fingers`);
        }

        function leavePatientMonitoring() {
            const patientName = document.getElementById('patientName').textContent;
            if (confirm(`Are you sure you want to stop monitoring ${patientName}?`)) {
                if (recognition) {
                    recognition.stop();
                }
                window.location.href = '/modules';
            }
        }
    </script>
</body>
</html>